openapi: 3.1.0
info:
  title: Pteron Internal API
  version: 1.0.0
  description: |
    ダッシュボードおよびフロントエンド向けの内部API。
servers:
  - url: /api/internal
components:
  securitySchemes:
    ForwardAuth:
      type: apiKey
      in: header
      name: X-Forwarded-User
      description: プロキシが付与するユーザーIDヘッダー

  schemas:
    User:
      type: object
      description: ユーザー
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          description: traP ID
        balance:
          type: integer
          format: int64
          description: 現在の残高

    Project:
      type: object
      description: プロジェクト
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        url:
          type: string
          format: uri
        owner_id:
          type: string
          format: uuid
        admin_ids:
          type: array
          items:
            type: string
            format: uuid
          description: プロジェクト管理者のユーザーID一覧
        balance:
          type: integer
          format: int64

    Transaction:
      type: object
      description: 完了した取引
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [TRANSFER, BILL_PAYMENT]
          description: |
            取引の種類
            - TRANSFER: プロジェクトからユーザーへの送金 (Project -> User)
            - BILL_PAYMENT: プロジェクトへの請求の支払い (User -> Project)
            - SYSTEM: システムからプロジェクトorユーザーへの支払い
        amount:
          type: integer
          format: int64
        project_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        description:
          type: string
        created_at:
          type: string
          format: date-time

    Bill:
      type: object
      description: 請求
      properties:
        id:
          type: string
          format: uuid
        amount:
          type: integer
          format: int64
        user_id:
          type: string
          format: uuid
          description: 請求対象のユーザーID
        description:
          type: string
        project_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [PENDING, COMPLETED, REJECTED, FAILED]
        created_at:
          type: string
          format: date-time

    APIClient:
      type: object
      description: APIクライアント
      properties:
        client_id:
          type: string
        client_secret:
          type: string
          description: 作成時のみ返却される
        created_at:
          type: string
          format: date-time

security:
  - ForwardAuth: []

paths:
  # --- Me (Personal Context) ---
  /me:
    get:
      tags: [Me]
      summary: 自分の情報を取得
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /me/bills/{bill_id}:
    get:
      tags: [Me]
      summary: 請求の詳細を取得
      parameters:
        - name: bill_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Bill'

  /me/bills/{bill_id}/approve:
    post:
      tags: [Me]
      summary: 請求を承認して支払いを実行する
      description: 成功した場合、プロジェクトが指定したリダイレクトURLを返す
      parameters:
        - name: bill_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 支払い完了
          content:
            application/json:
              schema:
                type: object
                properties:
                  redirect_url:
                    type: string
                    format: uri
        '400':
          description: 残高不足など
        '409':
          description: 既に処理済み

  /me/bills/{bill_id}/decline:
    post:
      tags: [Me]
      summary: 請求を拒否する
      parameters:
        - name: bill_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: 拒否完了
        '409':
          description: 既に処理済み


  # --- Transactions ---
  /transactions:
    get:
      tags: [Transactions]
      summary: 経済圏全体の取引履歴を取得
      parameters:
        - name: term
          in: query
          schema:
            type: string
            enum:
              - 24hours
              - 7days
              - 30days
              - 365days
            description: これが指定されている場合は、limitやcursorを無視し、全件返す
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: cursor
          in: query
          schema:
            type: string
            description: |
              続きを取得するためのカーソル
              前回のレスポンスの next_cursor に含まれる値を指定します。
              初回リクエスト時は未指定とします。
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
                  next_cursor:
                    type: string
                    description: 次のページを取得するためのカーソル

  /transactions/users/{user_id}:
    get:
      tags: [Transactions]
      summary: 特定のユーザーの取引履歴を取得
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
        - name: term
          in: query
          schema:
            type: string
            enum:
              - 24hours
              - 7days
              - 30days
              - 365days
            description: これが指定されている場合は、limitやcursorを無視し、全件返す
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: cursor
          in: query
          schema:
            type: string
            description: |
              続きを取得するためのカーソル
              前回のレスポンスの next_cursor に含まれる値を指定します。
              初回リクエスト時は未指定とします。
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
                  next_cursor:
                    type: string
                    description: 次のページを取得するためのカーソル
  /transactions/projects/{project_id}:
    get:
      tags: [Transactions]
      summary: 特定のプロジェクトの取引履歴を取得
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
        - name: term
          in: query
          schema:
            type: string
            enum:
              - 24hours
              - 7days
              - 30days
              - 365days
            description: これが指定されている場合は、limitやcursorを無視し、全件返す
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: cursor
          in: query
          schema:
            type: string
            description: |
              続きを取得するためのカーソル
              前回のレスポンスの next_cursor に含まれる値を指定します。
              初回リクエスト時は未指定とします。
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
                  next_cursor:
                    type: string
                    description: 次のページを取得するためのカーソル

  # --- Stats ---
  /stats:
    get:
      tags: [Stats]
      summary: 経済圏全体の統計情報を取得
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: cursor
          in: query
          schema:
            type: string
            description: |
              続きを取得するためのカーソル
              前回のレスポンスの next_cursor に含まれる値を指定します。
              初回リクエスト時は未指定とします。
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
                  next_cursor:
                    type: string
                    description: 次のページを取得するためのカーソル
  /stats/users:
    get:
      tags: [Stats]
      summary: ユーザー関連の統計情報を取得
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: cursor
          in: query
          schema:
            type: string
            description: |
              続きを取得するためのカーソル
              前回のレスポンスの next_cursor に含まれる値を指定します。
              初回リクエスト時は未指定とします。
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
                  next_cursor:
                    type: string
                    description: 次のページを取得するためのカーソル
  /stats/projects:
    get:
      tags: [Stats]
      summary: プロジェクト関連の統計情報を取得
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: cursor
          in: query
          schema:
            type: string
            description: |
              続きを取得するためのカーソル
              前回のレスポンスの next_cursor に含まれる値を指定します。
              初回リクエスト時は未指定とします。
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
                  next_cursor:
                    type: string
                    description: 次のページを取得するためのカーソル
  /stats/users/{ranking_name}:
    get:
      tags: [Stats]
      summary: ユーザー関連のランキングを取得
      parameters:
        - name: rankine_name
          in: path
          required: true
          schema:
            type: string
            enum:
              - balance # 終了時点での残高
              - difference # 期間前と現在の差
              - in # 入金総額
              - out # 出金総額
              - count # 取引件数
              - total # 取引総額(入金と送金の合計)
              - ratio # 期間前の残高から何%増えた・減ったか
        - name: order
          in: query
          schema:
            type: string
            enum:
              - desc
              - asc
            description: デフォルトはdesc(降順)
        - name: term
          required: true
          in: query
          schema:
            type: string
            enum:
              - 24hours
              - 7days
              - 30days
              - 365days
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: cursor
          in: query
          schema:
            type: string
            description: |
              続きを取得するためのカーソル
              前回のレスポンスの next_cursor に含まれる値を指定します。
              初回リクエスト時は未指定とします。
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:

                      $ref: '#/components/schemas/Transaction'
                  next_cursor:
                    type: string
                    description: 次のページを取得するためのカーソル
  /stats/projects/{ranking_name}:
    get:
      tags: [Stats]
      summary: プロジェクト関連のランキングを取得
      parameters:
        - name: rankine_name
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: cursor
          in: query
          schema:
            type: string
            description: |
              続きを取得するためのカーソル
              前回のレスポンスの next_cursor に含まれる値を指定します。
              初回リクエスト時は未指定とします。
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
                  next_cursor:
                    type: string
                    description: 次のページを取得するためのカーソル


  # --- Users (Public Context) ---
  /users:
    get:
      tags: [Users]
      summary: 全ユーザー一覧を取得
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: cursor
          in: query
          schema:
            type: string
            description: |
              続きを取得するためのカーソル
              前回のレスポンスの next_cursor に含まれる値を指定します。
              初回リクエスト時は未指定とします。
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
                  next_cursor:
                    type: string
                    description: 次のページを取得するためのカーソル (存在しない場合は未設定)

  /users/{user_id}:
    get:
        tags: [Users]
        parameters:
          - name: user_id
            in: path
            required: true
            schema:
              type: string
        summary: ユーザー詳細
        responses:
          '200':
            description: OK
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/User'

  /users/{user_id}/balance:
    get:
        tags: [Users]
        parameters:
          - name: user_id
            in: path
            required: true
            schema:
              type: string
          - name: data
            in: query
            schema:
              type: string
              format: date-time
              description: 無い場合は現在時刻
        summary: 特定日時でのユーザーの残高
        responses:
          '200':
            description: OK
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    balance:
                      type: integer
                      format: int64

  /users/{user_id}/projects:
    get:
      tags: [Users]
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
      summary: 指定したユーザーがオーナーまたは管理者のプロジェクト一覧
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Project'

  # --- Projects (Admin Context) ---
  /projects:
    get:
      tags: [Projects]
      summary: 全プロジェクト一覧を取得
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: cursor
          in: query
          schema:
            type: string
            description: |
              続きを取得するためのカーソル
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Project'
                  next_cursor:
                    type: string
                    description: 次のページを取得するためのカーソル
    post:
      tags: [Projects]
      summary: プロジェクトを新規作成
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 1
                url:
                  type: string
                  format: uri
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'

  /projects/{project_id}:
    get:
      tags: [Projects]
      summary: プロジェクト詳細
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'

  /projects/{project_id}/balance:
    get:
        tags: [Projects]
        parameters:
          - name: data
            in: query
            schema:
              type: string
              format: date-time
              description: 無い場合は現在時刻
        summary: 特定日時でのプロジェクトの残高
        responses:
          '200':
            description: OK
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    balance:
                      type: integer
                      format: int64

  /projects/{project_id}/admins:
    get:
      tags: [Projects]
      summary: プロジェクト管理者一覧を取得
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
    post:
      tags: [Projects]
      summary: プロジェクト管理者を追加
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_id]
              properties:
                user_id:
                  type: string
                  format: uuid
      responses:
        '204':
          description: Added

  /projects/{project_id}/admins/{user_id}:
    delete:
      tags: [Projects]
      summary: プロジェクト管理者を削除
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted

  /projects/{project_id}/clients:
    get:
      tags: [Projects]
      summary: APIクライアント一覧
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/APIClient'
    post:
      tags: [Projects]
      summary: APIクライアントを新規発行
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '201':
          description: Created (Secretはここでしか表示しない)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIClient'

  /projects/{project_id}/clients/{client_id}:
    delete:
      tags: [Projects]
      summary: APIクライアントを削除（無効化）
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
        - name: client_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Deleted

# 特定日時のランキング
#特定ユーザーのランキング
